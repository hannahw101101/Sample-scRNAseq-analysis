---
title: "Analysis Dataset HMS"
output: html_document
date: "2025-09-18"
---

```{r}
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.21")

# Install Bioconductor required packages
BiocManager::install("DESeq2")
BiocManager::install("EnhancedVolcano")
BiocManager::install("SingleCellExperiment")
BiocManager::install("miloR")
BiocManager::install("clusterProfiler")
BiocManager::install("org.Mm.eg.db")
BiocManager::install("sccomp")
BiocManager::install("speckle")

# Install CRAN required packages
install.packages("pheatmap")
install.packages("ggalluvial")
install.packages("msigdbr")
install.packages("ggvenn")
install.packages("tidyverse")

# Load libraries
library(Seurat)
library(tidyverse)
library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(dplyr)
library(DESeq2)
library(EnhancedVolcano)
library(SingleCellExperiment)
library(miloR)
library(ggalluvial)
library(clusterProfiler)
library(org.Mm.eg.db)
library(msigdbr)
library(ggvenn)
library(sccomp)
library(speckle)
library(ggplot2)
library(patchwork)
```

Merged together the wildtype and mutant datasets for future analysis 
```{r}
mt1.data <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/mt1")
mt1 <- CreateSeuratObject(counts = mt1.data, project = "mt1", min.cells = 3, min.features = 200)

mt2 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/mt2")
mt2 <- CreateSeuratObject(counts = mt2, project = "mt2", min.cells = 3, min.features = 200)

mt3 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/mt3")
mt3 <- CreateSeuratObject(counts = mt3, project = "mt3", min.cells = 3, min.features = 200)

wt1 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/wt1")
wt1 <- CreateSeuratObject(counts = wt1, project = "wt1", min.cells = 3, min.features = 200)

wt2 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/wt2")
wt2 <- CreateSeuratObject(counts = wt2, project = "wt2", min.cells = 3, min.features = 200)

```


Doing QC
```{r}
QC = function(sample) {
  # Remove unwanted cells
  sample[["percent.mt"]] <- PercentageFeatureSet(sample, pattern = "^MT-")
  sample <- subset(sample, subset = nFeature_RNA > 200 & nFeature_RNA < 6000 & percent.mt < 10)

  # Normalize the dataset using standard normalization method 
  sample <- NormalizeData(sample, normalization.method = "LogNormalize", scale.factor = 1e4)

  # Limit to only most variable features to shrink dataset 
  sample <- FindVariableFeatures(sample, selection.method = 'vst', nfeatures = 2000)

  # Scale to mean 0 and variance 1 so highly expressed genes don't dominate 
  all.genes <- rownames(sample)
  sample <- ScaleData(sample, features = all.genes)
  return(sample)
  }

mt1 = QC(mt1)
# Perform PCA 
mt1 <- RunPCA(mt1, features = VariableFeatures(object = mt1))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(mt1)

# Cluster with UMAP 
mt1 <- FindNeighbors(mt1, dims = 1:5)
mt1 <- FindClusters(mt1, resolution = 0.5)
mt1 <- RunUMAP(mt1, dims = 1:5)
DimPlot(mt1, reduction = 'umap')

mt2 = QC(mt2)
# Perform PCA 
mt2 <- RunPCA(mt2, features = VariableFeatures(object = mt2))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(mt2)

# Cluster with UMAP 
mt2 <- FindNeighbors(mt2, dims = 1:5)
mt2 <- FindClusters(mt2, resolution = 0.5)
mt2 <- RunUMAP(mt2, dims = 1:5)
DimPlot(mt2, reduction = 'umap')

mt3 = QC(mt3)
# Perform PCA 
mt3 <- RunPCA(mt3, features = VariableFeatures(object = mt3))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(mt3)

# Cluster with UMAP 
mt3 <- FindNeighbors(mt3, dims = 1:5)
mt3 <- FindClusters(mt3, resolution = 0.5)
mt3 <- RunUMAP(mt3, dims = 1:5)
DimPlot(mt3, reduction = 'umap')

wt1 = QC(wt1)
# Perform PCA 
wt1 <- RunPCA(wt1, features = VariableFeatures(object = wt1))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(wt1)

# Cluster with UMAP 
wt1 <- FindNeighbors(wt1, dims = 1:5)
wt1 <- FindClusters(wt1, resolution = 0.5)
wt1 <- RunUMAP(wt1, dims = 1:5)
DimPlot(wt1, reduction = 'umap')

wt2 = QC(wt2)
# Perform PCA 
wt2 <- RunPCA(wt2, features = VariableFeatures(object = wt2))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(wt2)

# Cluster with UMAP 
wt2 <- FindNeighbors(wt2, dims = 1:5)
wt2 <- FindClusters(wt2, resolution = 0.5)
wt2 <- RunUMAP(wt2, dims = 1:5)
DimPlot(wt2, reduction = 'umap')

```
Merge mutant and wildtype datasets for analysis

```{r}
mt.all <- merge(mt1, y = c(mt2, mt3), add.cell.id = c("mt1", "mt2", "mt3"), merge.data = TRUE)
wt.all <- merge(wt1, y = c(wt2), add.cell.id = c("wt1", "wt2"), merge.data = TRUE)

mt.all <- FindVariableFeatures(mt.all, selection.method = 'vst', nfeatures = 2000)

all.genes <- rownames(mt.all)
mt.all <- ScaleData(mt.all, features = all.genes)
mt.all <- RunPCA(mt.all, features = VariableFeatures(object = mt.all))
ElbowPlot(mt.all)

mt.all <- FindNeighbors(mt.all, dims = 1:5) # Edit dims based on ElbowPlot
mt.all <- FindClusters(mt.all, resolution = 0.4) 
mt.all <- RunUMAP(mt.all, dims = 1:5)

# Plot by sample to see if properly merged 
DimPlot(mt.all, reduction = 'umap', label = FALSE, label.box = TRUE, split.by = "orig.ident")




wt.all <- FindVariableFeatures(wt.all, selection.method = 'vst', nfeatures = 2000)

all.genes <- rownames(wt.all)
wt.all <- ScaleData(wt.all, features = all.genes)
wt.all <- RunPCA(wt.all, features = VariableFeatures(object = wt.all))
ElbowPlot(wt.all)

wt.all <- FindNeighbors(wt.all, dims = 1:5) # Edit dims based on ElbowPlot
wt.all <- FindClusters(wt.all, resolution = 0.4) 
wt.all <- RunUMAP(wt.all, dims = 1:5)

# Plot by sample to see if properly merged 
DimPlot(wt.all, reduction = 'umap', label = FALSE, label.box = TRUE, split.by = "orig.ident")
```

Samples are properly merged with all samples having cells in each cluster, so no need to integrate. Can now run DEA 

```{r}
# Cell Type Analysis on Mutant cells 
# Common genes expressed in cell types in drosophila 

# Neurons
VlnPlot(wt.all, features = c("elav", "Fas2", "trio"))

# Glia
VlnPlot(wt.all, features = c("repo", "glial"))

# Muscle
VlnPlot(wt.all, features = c("Mhc"))

# Fat body
VlnPlot(wt.all, features = c("Lsp2"))

# Ovary
VlnPlot(wt.all, features = c("Orb", "esg"))

# Blood Cells
VlnPlot(wt.all, features = c("Hml", "P1", "P2"))


```
0: Muscle
1: Muscle
2: Muscle 
3: Neuron
4: Neuron 
5: Neuron 
6: Neuron 
7: Neuron 
8: Neuron 






```{r}
# Cell Type Analysis on Wild Type cells 

# Neurons
VlnPlot(wt.all, features = c("elav", "Fas2", "trio"))

# Glia
VlnPlot(wt.all, features = c("repo", "glial"))

# Muscle
VlnPlot(wt.all, features = c("Mhc"))

# Fat body
VlnPlot(wt.all, features = c("Lsp2"))

# Ovary
VlnPlot(wt.all, features = c("Orb", "esg"))

# Blood Cells
VlnPlot(wt.all, features = c("Hml", "P1", "P2"))


```

0: Muscle
1: Muscle
2: Muscle
3: Neuron 
4: Neuron
5: Neuron 
6: Neuron 
7: Neuron 
8: Neuron 



```{r}

```

```{r, Load object}
# Load Seurat object containing tpos and tneg for Mayo 026
clusters <- readRDS("/home/haw353/merged.rds")

# View column names
colnames(clusters@meta.data)
```

```{r, Data viz}
# Number of cells per sample
ggplot(clusters@meta.data) +
  geom_bar(aes(x=orig.ident, fill = nCount_RNA),
           stat = "count", color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  labs(x="Sample name", y = "Number of cells")

# UMAP of sample
DimPlot(clusters, group.by = "orig.ident")

# UMAP clusters
p <- DimPlot(clusters, group.by = "seurat_clusters") + NoLegend()
LabelClusters(p, id = "seurat_clusters", fonface = "bold", size = 5,
              bg.colour = "white", bg.r = .2, force = 0)

```


```{r, clusters to celltype}
# Map clusters to celltype
# Need to add cell type column to Seurat object 
clusters$celltype <- NA # to create an empty column
```

# Assign cell types based on cluster IDs 

# Assignment reminder



```{r Add celltypes to metadata}

clusters$celltype[clusters$seurat_clusters == 0] <- "Oligodendrocytes"
clusters$celltype[clusters$seurat_clusters == 1] <- "Oligodendrocytes"
clusters$celltype[clusters$seurat_clusters == 2] <- "Oligodendrocytes"
clusters$celltype[clusters$seurat_clusters == 3] <- "Unknown"
clusters$celltype[clusters$seurat_clusters == 4] <- "Excitatory"
clusters$celltype[clusters$seurat_clusters == 5] <- "Microglia"
clusters$celltype[clusters$seurat_clusters == 6] <- "Astrocyte"
clusters$celltype[clusters$seurat_clusters == 7] <- "Inhibitory"
clusters$celltype[clusters$seurat_clusters == 8] <- "Astrocyte"
clusters$celltype[clusters$seurat_clusters == 9] <- "Astrocyte"
clusters$celltype[clusters$seurat_clusters == 10] <- "OPC"
clusters$celltype[clusters$seurat_clusters == 11] <- "Inhibitory"
clusters$celltype[clusters$seurat_clusters == 12] <- "Inhibitory"
clusters$celltype[clusters$seurat_clusters == 13] <- "Excitatory"
clusters$celltype[clusters$seurat_clusters == 14] <- "Excitatory"
clusters$celltype[clusters$seurat_clusters == 15] <- "Endothelial"
clusters$celltype[clusters$seurat_clusters == 16] <- "Inhibitory"
clusters$celltype[clusters$seurat_clusters == 17] <- "Unknown"
clusters$celltype[clusters$seurat_clusters == 18] <- "Unknown"
clusters$celltype[clusters$seurat_clusters == 19] <- "Excitatory"
clusters$celltype[clusters$seurat_clusters == 20] <- "Inhibitory"

# Check number of cells in each cluster assignment
table(clusters$celltype)

#Astrocyte      Endothelial       Excitatory       Inhibitory        Microglia Oligodendrocytes 
#3753              390             3190             3184             1461            17487 
#OPC          Unknown 
#1004             2467 

# Check number of cells by sample 
table(clusters$orig.ident)

#TnegM025 TnegM026 TnegM027 TnegM028 TposM025 tposM026 TposM027 TposM028 
#4701     3496     3831     5359     5072     4742     2244     3491 

# Save new object with cell types
saveRDS(clusters, file = "mergedn279k_celltypes.rds")

# Load object with cell types
clusters <- readRDS("mergedn279k_celltypes.rds")
```

```{r, alluvial plot, fig.height=8, fig.width=10}

# Alluvial plot to see which clusters have been annotated with which cell types
# These plots show how data flows or changes through 
# multiple dimensions

# Order clusters numerically
order_cluster <- unique(clusters$seurat_clusters) %>% as.numeric() %>% sort() %>% as.character()
clusters$seurat_clusters <- factor(clusters$seurat_clusters, levels=order_cluster)

ggplot(clusters@meta.data,
       aes(axis1 = seurat_clusters,
           axis2 = celltype,
           fill = celltype)) +
  geom_alluvium() +
  geom_stratum() +
  geom_text_repel(stat = "stratum",
            aes(label=after_stat(stratum))) +
  theme_void() +
  NoLegend() +
  coord_flip()
```
``` {r, umap celltype, fig.height=8, fig.width=10}

# UMAP celltype
Idents(clusters) <- "celltype"
p <- DimPlot(clusters) + NoLegend()
LabelClusters(p, id = "ident", fontfact = "bold", size = 4,
              bg.colour = "white", bg.r = .2, force =0)

# Run in the consol 
```
```{r, proportions, echo=FALSE, fig.height=8, fig.width=5}
ggplot(clusters@meta.data) +
  geom_bar(aes(x=orig.ident, fill=celltype, width = .01),
           position=position_fill(), color="black") +
  theme_classic() +
  scale_fill_brewer(palette = "Set1")
  labs(x="celltype", y = "Proportion of cells")
```
# Look at Phase D Genes: 

phaseD <- read.csv("phaseD.csv")

phaseDgenes <- subset(clusters, features = phaseD$genes)

phaseDgenes$type <- NA # to create an empty column

phaseDgenes$type[phaseDgenes$orig.ident == "TposM025"] <- "pos"
phaseDgenes$type[phaseDgenes$orig.ident == "tposM026"] <- "pos"
phaseDgenes$type[phaseDgenes$orig.ident == "TposM027"] <- "pos"
phaseDgenes$type[phaseDgenes$orig.ident == "TposM028"] <- "pos"
phaseDgenes$type[phaseDgenes$orig.ident == "TnegM025"] <- "neg"
phaseDgenes$type[phaseDgenes$orig.ident == "TnegM026"] <- "neg"
phaseDgenes$type[phaseDgenes$orig.ident == "TnegM027"] <- "neg"
phaseDgenes$type[phaseDgenes$orig.ident == "TnegM028"] <- "neg"

Idents(phaseDgenes) <- "type"

# Set default assay to ensure we are inputing normalized data
# NOT integrated data (if applicable)
DefaultAssay(phaseDgenes) <- "RNA"

# Fixing it? 
phaseDgenes <- JoinLayers(phaseDgenes)

# Running FindMarkers
dge_phaseD <- FindMarkers(phaseDgenes, 
                          ident.1 = "pos", 
                          ident.2 = "neg")

saveRDS(dge_phaseD, file = "findmarkers_n279kphaseD.rds")

write.csv(dge_phaseD, "findmarkers_n279kphaseD_tpos_vs_tneg.csv")

# Read for future use
dge_phaseD_sig <- readRDS("findmarkers_n279kphaseD.rds")

# Subset significant genes
dge_phaseD_sig <- dge_phaseS %>% subset(p_val_adj < 0.05)
dge_phaseD_sig %>% head()

# Volcano plot
p <- EnhancedVolcano(dge_oligos_sig, 
                     row.names(dge_oligos_sig),
                     x = "avg_log2FC",
                     y = "p_val_adj",
                     title = "FindMarkers DEG Oligodendrocytes",
                     subtitle = "tpos vs. tneg")

print(p)


```













