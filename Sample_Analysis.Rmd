---
title: "Analysis Dataset HMS"
output: html_document
date: "2025-09-18"
---

```{r}
library(dplyr)
library(Seurat)
library(patchwork)
```

Merged together the wildtype and mutant datasets for future analysis 
```{r}
mt1.data <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/mt1")
mt1 <- CreateSeuratObject(counts = mt1.data, project = "mt1", min.cells = 3, min.features = 200)

mt2 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/mt2")
mt2 <- CreateSeuratObject(counts = mt2, project = "mt2", min.cells = 3, min.features = 200)

mt3 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/mt3")
mt3 <- CreateSeuratObject(counts = mt3, project = "mt3", min.cells = 3, min.features = 200)

wt1 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/wt1")
wt1 <- CreateSeuratObject(counts = wt1, project = "wt1", min.cells = 3, min.features = 200)

wt2 <- Read10X("/Users/hannahwilcox/Documents/sample_scRNA_sequencing_data/wt2")
wt2 <- CreateSeuratObject(counts = wt2, project = "wt2", min.cells = 3, min.features = 200)

```


Doing QC
```{r}
QC = function(sample) {
  # Remove unwanted cells
  sample[["percent.mt"]] <- PercentageFeatureSet(sample, pattern = "^MT-")
  sample <- subset(sample, subset = nFeature_RNA > 200 & nFeature_RNA < 6000 & percent.mt < 10)

  # Normalize the dataset using standard normalization method 
  sample <- NormalizeData(sample, normalization.method = "LogNormalize", scale.factor = 1e4)

  # Limit to only most variable features to shrink dataset 
  sample <- FindVariableFeatures(sample, selection.method = 'vst', nfeatures = 2000)

  # Scale to mean 0 and variance 1 so highly expressed genes don't dominate 
  all.genes <- rownames(sample)
  sample <- ScaleData(sample, features = all.genes)
  return(sample)
  }

mt1 = QC(mt1)
# Perform PCA 
mt1 <- RunPCA(mt1, features = VariableFeatures(object = mt1))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(mt1)

# Cluster with UMAP 
mt1 <- FindNeighbors(mt1, dims = 1:5)
mt1 <- FindClusters(mt1, resolution = 0.5)
mt1 <- RunUMAP(mt1, dims = 1:5)
DimPlot(mt1, reduction = 'umap')

mt2 = QC(mt2)
# Perform PCA 
mt2 <- RunPCA(mt2, features = VariableFeatures(object = mt2))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(mt2)

# Cluster with UMAP 
mt2 <- FindNeighbors(mt2, dims = 1:5)
mt2 <- FindClusters(mt2, resolution = 0.5)
mt2 <- RunUMAP(mt2, dims = 1:5)
DimPlot(mt2, reduction = 'umap')

mt3 = QC(mt3)
# Perform PCA 
mt3 <- RunPCA(mt3, features = VariableFeatures(object = mt3))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(mt3)

# Cluster with UMAP 
mt3 <- FindNeighbors(mt3, dims = 1:5)
mt3 <- FindClusters(mt3, resolution = 0.5)
mt3 <- RunUMAP(mt3, dims = 1:5)
DimPlot(mt3, reduction = 'umap')

wt1 = QC(wt1)
# Perform PCA 
wt1 <- RunPCA(wt1, features = VariableFeatures(object = wt1))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(wt1)

# Cluster with UMAP 
wt1 <- FindNeighbors(wt1, dims = 1:5)
wt1 <- FindClusters(wt1, resolution = 0.5)
wt1 <- RunUMAP(wt1, dims = 1:5)
DimPlot(wt1, reduction = 'umap')

wt2 = QC(wt2)
# Perform PCA 
wt2 <- RunPCA(wt2, features = VariableFeatures(object = wt2))

# Assess ElbowPlot for dimensions to maintain 
ElbowPlot(wt2)

# Cluster with UMAP 
wt2 <- FindNeighbors(wt2, dims = 1:5)
wt2 <- FindClusters(wt2, resolution = 0.5)
wt2 <- RunUMAP(wt2, dims = 1:5)
DimPlot(wt2, reduction = 'umap')

```
Merge mutant and wildtype datasets for analysis

```{r}
mt.all <- merge(mt1, y = c(mt2, mt3), add.cell.id = c("mt1", "mt2", "mt3"), merge.data = TRUE)
wt.all <- merge(wt1, y = c(wt2), add.cell.id = c("wt1", "wt2"), merge.data = TRUE)

mt.all <- FindVariableFeatures(mt.all, selection.method = 'vst', nfeatures = 2000)

all.genes <- rownames(mt.all)
mt.all <- ScaleData(mt.all, features = all.genes)
mt.all <- RunPCA(mt.all, features = VariableFeatures(object = mt.all))
ElbowPlot(mt.all)

mt.all <- FindNeighbors(mt.all, dims = 1:5) # Edit dims based on ElbowPlot
mt.all <- FindClusters(mt.all, resolution = 0.4) 
mt.all <- RunUMAP(mt.all, dims = 1:5)

# Plot by sample to see if properly merged 
DimPlot(mt.all, reduction = 'umap', label = FALSE, label.box = TRUE, split.by = "orig.ident")




wt.all <- FindVariableFeatures(wt.all, selection.method = 'vst', nfeatures = 2000)

all.genes <- rownames(wt.all)
wt.all <- ScaleData(wt.all, features = all.genes)
wt.all <- RunPCA(wt.all, features = VariableFeatures(object = wt.all))
ElbowPlot(wt.all)

wt.all <- FindNeighbors(wt.all, dims = 1:5) # Edit dims based on ElbowPlot
wt.all <- FindClusters(wt.all, resolution = 0.4) 
wt.all <- RunUMAP(wt.all, dims = 1:5)

# Plot by sample to see if properly merged 
DimPlot(wt.all, reduction = 'umap', label = FALSE, label.box = TRUE, split.by = "orig.ident")
```

Samples are properly merged with all samples having cells in each cluster, so no need to integrate. Can now run DEA 

```{r}
# Cell Type Analysis on Mutant cells 
# Common genes expressed in cell types in drosophila 

# Neurons
VlnPlot(wt.all, features = c("elav", "Fas2", "trio"))

# Glia
VlnPlot(wt.all, features = c("repo", "glial"))

# Muscle
VlnPlot(wt.all, features = c("Mhc"))

# Fat body
VlnPlot(wt.all, features = c("Lsp2"))

# Ovary
VlnPlot(wt.all, features = c("Orb", "esg"))

# Blood Cells
VlnPlot(wt.all, features = c("Hml", "P1", "P2"))


```
0: Muscle
1: Muscle
2: Muscle 
3: Neuron
4: Neuron 
5: Neuron 
6: Neuron 
7: Neuron 
8: Neuron 






```{r}
# Cell Type Analysis on Wild Type cells 

# Neurons
VlnPlot(wt.all, features = c("elav", "Fas2", "trio"))

# Glia
VlnPlot(wt.all, features = c("repo", "glial"))

# Muscle
VlnPlot(wt.all, features = c("Mhc"))

# Fat body
VlnPlot(wt.all, features = c("Lsp2"))

# Ovary
VlnPlot(wt.all, features = c("Orb", "esg"))

# Blood Cells
VlnPlot(wt.all, features = c("Hml", "P1", "P2"))


```

0: Muscle
1: Muscle
2: Muscle
3: Neuron 
4: Neuron
5: Neuron 
6: Neuron 
7: Neuron 
8: Neuron 














